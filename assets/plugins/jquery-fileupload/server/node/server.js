#!/usr/bin/env node
!function(e){"use strict";var c=require("path"),p=require("fs"),n=p.existsSync||c.existsSync,i=require("formidable"),d=require("node-static"),u=require("imagemagick"),h={tmpDir:__dirname+"/tmp",publicDir:__dirname+"/public",uploadDir:__dirname+"/public/files",uploadUrl:"/files/",maxPostSize:11e9,minFileSize:1,maxFileSize:1e10,acceptFileTypes:/.+/i,inlineFileTypes:/\.(gif|jpe?g|png)$/i,imageTypes:/\.(gif|jpe?g|png)$/i,imageVersions:{thumbnail:{width:80,height:80}},accessControl:{allowOrigin:"*",allowMethods:"OPTIONS, HEAD, GET, POST, PUT, DELETE",allowHeaders:"Content-Type, Content-Range, Content-Disposition"},nodeStatic:{cache:3600}},o=new d.Server(h.publicDir,h.nodeStatic),t=/(?:(?: \(([\d]+)\))?(\.[^.]+))?$/,a=function(e,i,t){return" ("+((parseInt(i,10)||0)+1)+")"+(t||"")},m=function(e){this.name=e.name,this.size=e.size,this.type=e.type,this.deleteType="DELETE"},s=function(e,i,t){this.req=e,this.res=i,this.callback=t},r=function(t,n){n.setHeader("Access-Control-Allow-Origin",h.accessControl.allowOrigin),n.setHeader("Access-Control-Allow-Methods",h.accessControl.allowMethods),n.setHeader("Access-Control-Allow-Headers",h.accessControl.allowHeaders);var e=function(){n.setHeader("Pragma","no-cache"),n.setHeader("Cache-Control","no-store, no-cache, must-revalidate"),n.setHeader("Content-Disposition",'inline; filename="files.json"')},i=new s(t,n,function(e,i){i?(n.writeHead(302,{Location:i.replace(/%s/,encodeURIComponent(JSON.stringify(e)))}),n.end()):(n.writeHead(200,{"Content-Type":-1!==t.headers.accept.indexOf("application/json")?"application/json":"text/plain"}),n.end(JSON.stringify(e)))});switch(t.method){case"OPTIONS":n.end();break;case"HEAD":case"GET":"/"===t.url?(e(),"GET"===t.method?i.get():n.end()):o.serve(t,n);break;case"POST":e(),i.post();break;case"DELETE":i.destroy();break;default:n.statusCode=405,n.end()}};o.respond=function(e,i,t,n,o,a,s,r){var l;t["X-Content-Type-Options"]="nosniff",h.inlineFileTypes.test(n[0])||(t["Content-Type"]="application/octet-stream",t["Content-Disposition"]='attachment; filename="'+(l=c.basename(n[0]),unescape(encodeURIComponent(l)))+'"'),d.Server.prototype.respond.call(this,e,i,t,n,o,a,s,r)},m.prototype.validate=function(){return h.minFileSize&&h.minFileSize>this.size?this.error="File is too small":h.maxFileSize&&h.maxFileSize<this.size?this.error="File is too big":h.acceptFileTypes.test(this.name)||(this.error="Filetype not allowed"),!this.error},m.prototype.safeName=function(){for(this.name=c.basename(this.name).replace(/^\.+/,"");n(h.uploadDir+"/"+this.name);)this.name=this.name.replace(t,a)},m.prototype.initUrls=function(e){if(!this.error){var i=this,t=(h.ssl?"https:":"http:")+"//"+e.headers.host+h.uploadUrl;this.url=this.deleteUrl=t+encodeURIComponent(this.name),Object.keys(h.imageVersions).forEach(function(e){n(h.uploadDir+"/"+e+"/"+i.name)&&(i[e+"Url"]=t+e+"/"+encodeURIComponent(i.name))})}},s.prototype.get=function(){var n=this,o=[];p.readdir(h.uploadDir,function(e,i){i.forEach(function(e){var i,t=p.statSync(h.uploadDir+"/"+e);t.isFile()&&"."!==e[0]&&((i=new m({name:e,size:t.size})).initUrls(n.req),o.push(i))}),n.callback({files:o})})},s.prototype.post=function(){var t,n=this,e=new i.IncomingForm,o=[],a=[],s={},r=1,l=function(){(r-=1)||(a.forEach(function(e){e.initUrls(n.req)}),n.callback({files:a},t))};e.uploadDir=h.tmpDir,e.on("fileBegin",function(e,i){o.push(i.path);var t=new m(i,n.req,!0);t.safeName(),s[c.basename(i.path)]=t,a.push(t)}).on("field",function(e,i){"redirect"===e&&(t=i)}).on("file",function(e,i){var t=s[c.basename(i.path)];t.size=i.size,t.validate()?(p.renameSync(i.path,h.uploadDir+"/"+t.name),h.imageTypes.test(t.name)&&Object.keys(h.imageVersions).forEach(function(e){r+=1;var i=h.imageVersions[e];u.resize({width:i.width,height:i.height,srcPath:h.uploadDir+"/"+t.name,dstPath:h.uploadDir+"/"+e+"/"+t.name},l)})):p.unlink(i.path)}).on("aborted",function(){o.forEach(function(e){p.unlink(e)})}).on("error",function(e){console.log(e)}).on("progress",function(e,i){e>h.maxPostSize&&n.req.connection.destroy()}).on("end",l).parse(n.req)},s.prototype.destroy=function(){var i,t=this;t.req.url.slice(0,h.uploadUrl.length)!==h.uploadUrl||"."===(i=c.basename(decodeURIComponent(t.req.url)))[0]?t.callback({success:!1}):p.unlink(h.uploadDir+"/"+i,function(e){Object.keys(h.imageVersions).forEach(function(e){p.unlink(h.uploadDir+"/"+e+"/"+i)}),t.callback({success:!e})})},h.ssl?require("https").createServer(h.ssl,r).listen(8888):require("http").createServer(r).listen(8888)}();