!function(p){function M(e){return e.find("> li > a:not(.disabled)").eq(0)}function m(e){return e.find("> li > a:not(.disabled)").eq(-1)}function h(e,s){var t=e.nextAll("li").children("a:not(.disabled)").eq(0);return s||t.length?t:M(e.parent())}function y(e,s){var t=e.prevAll("li").children("a:not(.disabled)").eq(0);return s||t.length?t:m(e.parent())}p.fn.focusSM=function(){return this.length&&this[0].focus&&this[0].focus(),this},p.extend(p.SmartMenus.Keyboard={},{docKeydown:function(e){var s=e.keyCode;if(/(27|37|38|39|40)/.test(s)){var t=p(this),a=t.data("smartmenus"),i=p(e.target);if(a&&i.is("a")){var n=i.parent(),u=n.parent(),o=u.dataSM("level");if(o){switch(a.opts.rightToLeftSubMenus&&(37==s?s=39:39==s&&(s=37)),s){case 27:if(a.visibleSubMenus[o])a.menuHide(a.visibleSubMenus[o]);else if(1==o)if(a.opts.isPopup&&a.menuHideAll(),a.opts.keyboardEscapeFocus)try{a.opts.keyboardEscapeFocus.focusSM()}catch(e){}else{var l=t.find("a, input, select, button, textarea").eq(-1),r=p("a, input, select, button, textarea"),c=r.index(l[0])+1;r.eq(c).focusSM()}else u.dataSM("parent-a").focusSM(),a.menuHide(a.visibleSubMenus[o-1]);break;case 37:if(a.isCollapsible())break;2<o||2==o&&t.hasClass("sm-vertical")?a.activatedItems[o-2].focusSM():t.hasClass("sm-vertical")||y(a.activatedItems[0].parent()).focusSM();break;case 38:var b;if(a.isCollapsible())1<o&&(b=M(u)).length&&i[0]==b[0]?a.activatedItems[o-2].focusSM():y(n).focusSM();else 1==o&&!t.hasClass("sm-vertical")&&a.visibleSubMenus[o]&&a.opts.bottomToTopSubMenus?m(a.visibleSubMenus[o]).focusSM():(1<o||t.hasClass("sm-vertical"))&&y(n).focusSM();break;case 39:if(a.isCollapsible())break;1!=o&&a.visibleSubMenus[o]||t.hasClass("sm-vertical")?a.visibleSubMenus[o]&&!a.visibleSubMenus[o].hasClass("mega-menu")&&M(a.visibleSubMenus[o]).focusSM():h(a.activatedItems[0].parent()).focusSM();break;case 40:var f,d;if(a.isCollapsible())if(a.visibleSubMenus[o]&&!a.visibleSubMenus[o].hasClass("mega-menu")&&(f=M(a.visibleSubMenus[o])).length)f.focusSM();else if(1<o&&(d=m(u)).length&&i[0]==d[0]){for(var v=a.activatedItems[o-2].parent(),S=null;v.is("li")&&!(S=h(v,!0)).length;)v=v.parent().parent();S.focusSM()}else h(n).focusSM();else 1!=o||t.hasClass("sm-vertical")||!a.visibleSubMenus[o]||a.opts.bottomToTopSubMenus?(1<o||t.hasClass("sm-vertical"))&&h(n).focusSM():M(a.visibleSubMenus[o]).focusSM()}e.stopPropagation(),e.preventDefault()}}}}}),p(document).delegate("ul.sm","keydown.smartmenus",p.SmartMenus.Keyboard.docKeydown),p.extend(p.SmartMenus.prototype,{keyboardSetEscapeFocus:function(e){this.opts.keyboardEscapeFocus=e},keyboardSetHotkey:function(e,i){var s=this;p(document).bind("keydown.smartmenus"+this.rootId,function(t){if(e==t.keyCode){var a=!0;i&&("string"==typeof i&&(i=[i]),p.each(["ctrlKey","shiftKey","altKey","metaKey"],function(e,s){return 0<=p.inArray(s,i)&&!t[s]||p.inArray(s,i)<0&&t[s]?a=!1:void 0})),a&&(M(s.$root).focusSM(),t.stopPropagation(),t.preventDefault())}})}})}(jQuery);